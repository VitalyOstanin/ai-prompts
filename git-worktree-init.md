Перед началом работы обязательно прочитай общие правила в файле `./common.md`.

# Промпт: Управление git worktree для client-api и core-libs

## Контекст
- Корневой каталог `client-api`: `~/devel/bitkogan/code/client-api`
- Корневой каталог `core-libs`: `~/devel/bitkogan/code/core-libs`
- В проектах используется структура подкаталогов под каждую ветку (`git worktree`).
- По умолчанию работаем с обеими кодовыми базами (`client-api`, `core-libs`).

## Цель ассистента
Автоматизировать подготовку рабочих копий на основе git worktree: получить ключевые слова задачи, построить согласованные названия ветки и каталога, создать worktree для каждого проекта, подготовить окружение и зафиксировать результат.

## Шаги

### 1. Сбор входных данных
- Выясни у пользователя контекст задачи: идентификатор (например, `BC-9131`), краткое описание, указание на релизную ветку (если требуется), перечень проектов (по умолчанию оба).
- Сформируй список ключевых слов. Минимум: идентификатор задачи + основные существительные из описания (в нижнем регистре и через дефис). Сохраняй регистр буквенно-цифровых идентификаторов (например, `BC-9131`).

### 2. Генерация имен
- Перед построением слага сделай экспресс-анализ кода ветки `stage` в соответствующем проекте: пробеги основные каталоги (`src`, `apps`, `packages`, `modules` и т.п.) и выпиши встречающиеся термины, совпадающие с доменной областью задачи.
- Используй найденные устойчивые термины, чтобы согласовать словарь задачи с уже существующими именами сущностей.
- Построй слаг `TASK_SLUG`, объединяя итоговый набор ключевых слов через дефис, без повторов, без пробелов. Пример: `BC-9131-miniapp-batch-deals`.
- Определи тип ветки:
  - **Stage (по умолчанию):** базовая ветка `origin/stage`, имя ветки `feature/stage-${TASK_SLUG}`.
  - **Release (по запросу пользователя):** базовая ветка `origin/master`, имя ветки `release/${TASK_SLUG}` (без префикса `stage-`).
- Имя каталога рабочей копии = часть ветки после последнего `/`. Примеры:
  - `feature/stage-BC-9131-miniapp-batch-deals` → каталог `stage-BC-9131-miniapp-batch-deals`
  - `release/BC-9131-miniapp-batch-deals` → каталог `BC-9131-miniapp-batch-deals`
- Покажи пользователю итоговые имена перед созданием worktree и дождись подтверждения.

### 3. Подготовка репозиториев
Для каждого выбранного проекта выполняй последовательность:
1. `cd` в корневой каталог проекта и зафиксируй `pwd`.
2. Убедись, что подкаталог для будущей рабочей копии отсутствует; если есть — согласуй с пользователем.
3. Перейди в любой существующий рабочий каталог (например, `master` или `stage`) и оттуда выполни `git fetch --all`.
4. Вернись в корень проекта или нужный служебный подкаталог, от которого создаются рабочие копии (например, `stage/`), если это принятая структура в репозитории. Проверяй `pwd` после каждого перехода.
5. Создай рабочую копию командой вида:
   ```bash
   git worktree add -b <branch_name> <relative_path_to_new_dir> <upstream_branch>
   ```
   Где `<relative_path_to_new_dir>` формируется так, чтобы новый каталог оказался в корне проекта (например, `../${WORKTREE_DIR}`).
6. После успешного добавления перейди в новую рабочую копию и настрой параметры ветки через `git config`, чтобы указать удалённый репозиторий и ссылку на ветку (пример для ветки `feature/stage-BC-9205-portfolio-batch-positions-yield`):
   ```bash
   git config branch.<branch_name>.remote origin
   git config branch.<branch_name>.merge refs/heads/<branch_name>
   ```
   Если ветка уже существует удалённо под другим именем, используй соответствующее значение в параметре `.merge`.
7. Зафиксируй абсолютный путь новой рабочей копии.

### 4. Пост-обработка рабочих копий
- Для `client-api` внутри новой рабочей копии создай (или переиспользуй) симлинк `.env`, указывающий на файл `env/.env`, расположенный в корне проекта:
  ```bash
  ln -sfn ../env/.env .env
  ```
  Прежде чем создавать ссылку, проверь наличие целевого файла и сообщи об ошибке, если файла нет.
- Для каждой новой рабочей копии выполни `npm install` (если существует `package.json`). Перед запуском озвучь действие, после — проверь код возврата.

### 5. Финальная фиксация
- Сводно выведи для пользователя:
  - `TASK_SLUG`
  - Имя ветки и базовую ветку для каждого проекта
  - Абсолютный путь рабочей копии
  - Статус создания симлинка `.env` (только для `client-api`)
  - Результат `npm install`
- При ошибках распиши точную команду и диагностическое сообщение.

## Дополнительные правила
- Не изменяй и не удаляй существующие рабочие каталоги без явного запроса пользователя.
- Если требуется подготовить только один из проектов, явно спроси какой и ограничь операции этим проектом.
- Перед повторным использованием существующих рабочих копий согласуй с пользователем.
- Храни командный вывод в кратком виде, но сохраняй важные предупреждения.
- Любое действие вне корня репозитория сопровождай проверкой `pwd` и выводом текущего каталога.

## Пример (stage)
```
Контекст: BC-9131, миниаппы, батчевые сделки
TASK_SLUG: BC-9131-miniapp-batch-deals
client-api → feature/stage-BC-9131-miniapp-batch-deals (origin/stage), каталог stage-BC-9131-miniapp-batch-deals
core-libs → feature/stage-BC-9131-miniapp-batch-deals (origin/stage), каталог stage-BC-9131-miniapp-batch-deals
Симлинк .env создан, npm install выполнен
```

## Пример (release)
```
Контекст: релиз BC-9999 hotfix payments
TASK_SLUG: BC-9999-hotfix-payments
client-api → release/BC-9999-hotfix-payments (origin/master), каталог BC-9999-hotfix-payments
core-libs → release/BC-9999-hotfix-payments (origin/master), каталог BC-9999-hotfix-payments
```
